FROM python:3.11-slim-bookworm

# üî¥ –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø ORANGE PI ZERO:
# - OPENBLAS –ºultithreading OFF (—Ç—ñ–ª—å–∫–∏ 1 —è–¥—Ä–æ)
# - NUMPY –Ω–∞ ARM –≤–∂–µ —Å–ª–∞–±–∫–∏–π, –±–µ–∑ OMP -> –∫—Ä–∞—â–µ
# - TFLite pre-built, –Ω–µ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è

ENV PIP_INDEX_URL=https://www.piwheels.org/simple \
    PIP_EXTRA_INDEX_URL=https://pypi.org/simple \
    PIP_NO_CACHE_DIR=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    OPENBLAS_NUM_THREADS=1 \
    OMP_NUM_THREADS=1 \
    ARMV6=1

RUN apt-get update && apt-get install -y --no-install-recommends \
      libgfortran5 libopenblas0-pthread ca-certificates \
      v4l-utils curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

WORKDIR /app
COPY requirements-orangepi-zero.txt requirements.txt .

# üü¢ –ö–õ–Æ–ß: --prefer-binary + piwheels (–¢–Ü–õ–¨–ö–ò wheels, –ù–Ü –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó!)
# timeout=300 (5 —Ö–≤–∏–ª–∏–Ω, –Ω–µ 15 —Å–µ–∫) - Orange Pi Zero –¥—É–∂–µ –ø–æ–≤—ñ–ª—å–Ω–∞
RUN pip install --prefer-binary \
      -r requirements.txt \
      --timeout=300 \
      --retries 5

COPY main.py model.tflite ./

EXPOSE 8000
CMD ["python", "-u", "main.py"]
