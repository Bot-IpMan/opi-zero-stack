# Arduino Mega 2560 Firmware

Цей каталог містить прошивку `opi_zero_stack.ino` для Arduino Mega 2560 з драйвером серво PCA9685 (I2C адреса 0x40). Прошивка отримує JSON-команди з хоста через послідовний порт (115200 бод) і транслює їх у положення сервоприводів.

## Бібліотеки Arduino

Для збирання скетчу встановіть через Library Manager:

- **Adafruit PWM Servo Driver Library** (`Adafruit_PWMServoDriver.h`)
- **ArduinoJson** (версія 6)

## Підключення

```
Arduino A4  ── SDA ──┐
Arduino A5  ── SCL ──┤── PCA9685 (адреса 0x40)
Arduino 5 V ── VCC ──┘
```

Серво підключаються до каналів 0–5 PCA9685 (можна змінити у константі `SERVO_CHANNELS`).

## Формат команди

Контейнер застосунку надсилає рядок JSON, закінчений `\r\n`, наприклад:

```json
{"seq": 1762351130994, "cmd": [0.1, 0.2, 0.3, 0.4, 0.5, 0.6]}
```

- `seq` — ідентифікатор пакета (число або рядок), відзеркалюється у відповіді.
- `cmd` — масив з шести чисел у діапазоні `0.0…1.0`, що відповідають сервоканалам.

Значення нормалізуються до імпульсів `500…2500 µs`. Прошивка повертає `OK seq=...` після успішного застосування або `ERR <код>` у разі помилки (`json_parse`, `cmd_size`, `cmd_type`, `cmd_nan`, `line_too_long`).

## Завантаження скетчу

Стек **не прошиває Arduino автоматично**: під час `docker compose up` контейнер лише очікує, що на платі вже працює відповідна версія прошивки. Залийте `opi_zero_stack.ino` вручну будь-яким зручним способом:

* через Arduino IDE, обравши плату **Arduino Mega 2560** та порт, який відповідає вашому `by-id` симлінку;
* або за допомогою Arduino CLI:

  ```bash
  arduino-cli compile --fqbn arduino:avr:mega firmware/mega2560
  arduino-cli upload --fqbn arduino:avr:mega -p /dev/serial/by-id/<ваш_mega> firmware/mega2560
  ```

Після успішного прошивання можна запускати Docker-стек — застосунок одразу підключиться до `/dev/ttyACM0`.

## Початкова поведінка

Після старту скетч ініціалізує PCA9685, встановлює всі серво у нейтральне положення та робить короткий «wiggle» усіма каналами, щоби підтвердити працездатність механіки.
