version: "3.9"

# Compose-файл для Orange Pi Zero: виконавчий сервіс та клієнт MQTT.
# Підключається до брокера, що працює на ПК (вкажіть його IP/хост у MQTT_HOST).
services:
  app:
    build:
      context: ./app
    container_name: robot-app
    network_mode: host  # Мінімізує затримки MQTT та дає прямий доступ до серійного порту.
    environment:
      SERIAL_DEV: ${SERIAL_DEV:-/dev/ttyACM0}
      CAMERA_DEVICE: ${CAMERA_DEVICE:-/dev/video0}
      CAMERA_WIDTH: ${CAMERA_WIDTH:-640}
      CAMERA_HEIGHT: ${CAMERA_HEIGHT:-480}
      MQTT_HOST: ${MQTT_HOST:-192.168.1.152}  # IP/хост ПК з брокером MQTT.
      MQTT_PORT: ${MQTT_PORT:-1883}
      PC_HOST: ${PC_HOST:-192.168.1.152}
      PC_PORT: ${PC_PORT:-8080}
      MODEL_PATH: ${MODEL_PATH:-/app/model.tflite}
      DUMMY_MODEL: ${DUMMY_MODEL:-1}
      SHARED_PATH: /app/shared
    volumes:
      - ./app/model.tflite:/app/model.tflite:ro
      - shared-data:/app/shared
    devices:
      - ${SERIAL_DEV:-/dev/ttyACM0}:${SERIAL_DEV:-/dev/ttyACM0}
      - ${CAMERA_DEVICE:-/dev/video0}:${CAMERA_DEVICE:-/dev/video0}
    device_cgroup_rules:
      - "c 166:* rmw"
    group_add:
      - "20"
    restart: unless-stopped
    mem_limit: "120m"
    pids_limit: 128
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/healthz || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: local
      options:
        max-size: "5m"
        max-file: "2"

  mqttc:
    image: alpine:3.20
    container_name: mqttc
    network_mode: host  # Використовує той самий IP, що й хост, для підключення до брокера на ПК.
    environment:
      MQTT_HOST: ${MQTT_HOST:-192.168.1.152}
      MQTT_PORT: ${MQTT_PORT:-1883}
    entrypoint:
      - "/bin/sh"
      - "-lc"
      - >-
        apk add --no-cache mosquitto-clients curl &&
        echo "Ready: docker compose exec mqttc sh" &&
        tail -f /dev/null
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_pub -h ${MQTT_HOST:-192.168.1.152} -p ${MQTT_PORT:-1883} -t healthcheck -m ok"]
      interval: 60s
      timeout: 10s
      retries: 3
    logging:
      driver: local
      options:
        max-size: "5m"
        max-file: "2"

volumes:
  shared-data:
    driver: local
