# OPi Zero Robot Arm Stack

Цей репозиторій містить мінімальний стек для керування роборукою на базі Orange Pi Zero / Armbian.
Стек складається з трьох сервісів Docker Compose: MQTT брокер Mosquitto, FastAPI застосунок,
який обробляє дані моделі та надсилає команди на Arduino Mega через послідовний порт, а також
сервіс `mqttc` з корисними MQTT-клієнтами для діагностики.

## Архітектура

```
Camera ──> FastAPI app ──> MQTT metrics ─> Mosquitto
                     \
                      └── serial JSON командою ─> Arduino Mega ─> роборука
```

* **`app/`** – застосунок з FastAPI + TFLite. За замовчуванням використовує `DUMMY_MODEL=1`, щоб
  працювати навіть без TensorFlow Lite.
* **`mosquitto/`** – конфігурація та каталоги для брокера.
* **`mqttc/`** – контейнер-утиліта для quick & dirty MQTT тестів.
* **`diag-opi.sh`** – скрипт для перевірки середовища на самій платі.

## Попередні вимоги

* Orange Pi Zero (або аналогічна SBC) з Armbian 25.8 або Debian 12.
* Встановлений Docker Engine 28+ та `docker compose`.
* Підключена Arduino Mega 2560 (CDC ACM) та камера Logitech C170.
* Udev-симлінки задіяні згідно `docker-compose.yml` (`/dev/serial/by-id/...`, `/dev/v4l/by-id/...`).

## Швидкий старт

1. Клонувати репозиторій на плату: `git clone https://…/opi-zero-stack.git`.
2. Переконатись, що симлінки `/dev/serial/by-id/usb-Arduino__www.arduino.cc__0042_*` та
   `/dev/v4l/by-id/usb-_Webcam_C170-video-index0` існують і вказують на character devices.
3. Запустити `docker compose up -d --build`.
4. Перевірити здоров'я застосунку: `curl http://localhost:8000/healthz`.
5. Надіслати тестовий запит:

```bash
curl -X POST http://localhost:8000/predict \
  -H 'Content-Type: application/json' \
  -d '{"x": [0.1, 0.2, 0.3, 0.4, 0.5, 0.6]}'
```

У відповідь отримаєте JSON з дією, часу інференсу та команда буде відправлена на Arduino.

## Чому роборука могла не працювати

Arduino Mega перезавантажується при відкритті послідовного порту, а прошивка очікує команди з
закінченням `\r\n`. Раніше перша команда губилася через відсутність затримки після відкриття
порту, а рядки завершувались лише `\n`. Тепер застосунок дає платі 2 секунди на ініціалізацію,
очищує буфери та відправляє команди з CRLF – прошивка отримує повні JSON пакети.

## Діагностика

На хості виконайте:

```bash
./diag-opi.sh
```

Скрипт перевірить:

* версії Docker / docker compose;
* коректність `docker-compose.yml`;
* наявність потрібних директорій Mosquitto;
* симлінки udev і те, що вони вказують на character devices;
* стан контейнерів і доступність `/healthz`;
* читання `model.tflite` всередині контейнера;
* MQTT pub/sub через контейнер `mqttc`;
* базову роботу послідовного порту.

Наприкінці скрипт виведе зведення з кількістю помилок.

## Змінні середовища застосунку

| Назва         | Значення за замовчуванням | Опис |
|---------------|---------------------------|------|
| `MODEL_PATH`  | `/app/model.tflite`       | Шлях до TFLite моделі в контейнері. |
| `SERIAL_DEV`  | `/dev/ttyACM0`            | Послідовний порт Arduino всередині контейнера. |
| `MQTT_HOST`   | `mqtt`                    | DNS-ім'я брокера. |
| `DUMMY_MODEL` | `1`                       | Якщо `1` – виконується "глушилка" (дані повертаються як є). |

## MQTT

* Метрики затримки публікуються у топік `arm/metrics`.
* Для швидкої перевірки:

```bash
docker compose exec mqttc mosquitto_sub -h mqtt -t 'arm/#' -v
```

## Оновлення / зупинка

* Перезібрати образ застосунку: `docker compose build app`.
* Зупинити стек: `docker compose down`.
* Оновити залежності Python – відредагуйте `app/requirements.txt` та перезапустіть збірку.

## Ліцензія

Цей проект розповсюджується під ліцензією MIT, якщо не зазначено інше у файлах. Внески вітаються!
